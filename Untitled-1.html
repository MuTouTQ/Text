<!-- 散粮生成计划 选择货页面 -->
<meta charset="UTF-8">
<table id="selectCargoDatagrid" style="height: 100%; fit: true"></table>
<script type="text/javascript">
    $(document).ready(function() {
        var dataPmsTyp = $.main.getDataPmsTyp();
        $.i18n.properties({
            name: 'logistic', //资源文件名称
            path: '../i18n/project/', //资源文件路径
            mode: 'map', //用Map的方式使用资源文件中的值
            language: getBrowserLanguage(),
            //language: "en",
            callback: function() { //加载成功后设置显示内容
                $("label").each(function(i) {
                    $(this).html($.i18n.prop($(this).attr("name")));
                });
            }
        });
        var contId = HdUtils.dialog.getValue("contId");
        // 条件类。
        var builderCargoDetl = new HdEzuiQueryParamsBuilder();
        builderCargoDetl.setAndClause("contId", contId, "=", "and");
        $("#selectCargoDatagrid").datagrid({
            striped: true,
            method: "POST",
            queryParams: builderCargoDetl.build(),
            url: "../webresources/login/YardContract/findCargo",
            pagination: true,
            singleSelect: true,
            checkOnSelect: true,
            selectOnCheck: false,
            rownumbers: true,
            showFooter: true,
            pageSize: 20,
            fit: true,
            fitColumns: false,
            onLoadSuccess: function(data) {
                HdUtils.ezui.CalcToFooter("selectCargoDatagrid", "cargoWgt");
            },
            columns: [
                [{
                    field: "contCargoId",
                    title: $.i18n.prop("主键"),
                    multiSort: true,
                    halign: "center",
                    width: 100,
                    hidden: true,
                    sortable: true
                }, {
                    field: "contId",
                    title: $.i18n.prop("合同ID"),
                    multiSort: true,
                    halign: "center",
                    width: 100,
                    hidden: true,
                    sortable: true
                }, {
                    field: "cargoTyp",
                    title: $.i18n.prop("货类"),
                    multiSort: true,
                    halign: "center",
                    width: 100,
                    hidden: true,
                    sortable: true
                }, {
                    field: "cargoId",
                    title: $.i18n.prop("货名"),
                    multiSort: true,
                    halign: "center",
                    width: 100,
                    editor: {
                        type: "combogrid",
                        options: HdUtils.code.Cargo({
                            parentId: "#selectCargoDatagrid",
                            isValid: false,
                            fieldMapping: {
                                cargoId: 'cargoNam'
                            },
                            required: false,
                            onSelect: function(rowIndex, rowData) {
                                var row = $("#selectCargoDatagrid").datagrid("getSelected");
                                var index = $("#selectCargoDatagrid").datagrid("getRowIndex", row);
                                $("#selectCargoDatagrid").datagrid('updateRowWhenEditing', {
                                    index: index,
                                    row: {
                                        cargoTyp: rowData.cargoKindId,
                                    }
                                });
                            }
                        })
                    },
                    formatter: function(value, row, index) {
                        if (row.cargoName != null && row.cargoName != "") {
                            return row.cargoName;
                        } else {
                            return value;
                        }
                    },
                    sortable: true
                }, {
                    field: "cargoWgt",
                    title: $.i18n.prop("数量(Kg)"),
                    multiSort: true,
                    halign: "center",
                    align: "right",
                    width: 90,
                    editor: {
                        type: "numberbox",
                        options: {
                            required: true,
                            precision: 3,
                            max: "9999999999.999",
                        }
                    },
                    formatter: function(value) {
                        return HdUtils.formatter.precisionCommon(value, 3);
                    },
                    sortable: true
                }, {
                    field: "consignor",
                    title: $.i18n.prop("发货人"),
                    multiSort: true,
                    halign: "center",
                    width: 120,
                    editor: {
                        type: "combogrid",
                        options: HdUtils.code.customerPay({
                            parentId: "#selectCargoDatagrid",
                            isValid: false,
                            fieldMapping: {
                                setOwner: 'custId'
                            },
                            required: false
                        })
                    },
                    formatter: function(value, row, index) {
                        if (row.consignorNam != null && row.consignorNam != "") {
                            return row.consignorNam;
                        } else {
                            return value;
                        }
                    },
                    sortable: true
                }, {
                    field: "startStation",
                    title: $.i18n.prop("发站"),
                    multiSort: true,
                    halign: "center",
                    width: 140,
                    editor: {
                        type: "combogrid",
                        options: HdUtils.code.station({
                            parentId: "#selectCargoDatagrid",
                            isValid: false,
                            fieldMapping: {
                                statStation: 'stationName'
                            },
                            required: false
                        })
                    },
                    formatter: function(value, row, index) {
                        if (row.startStationNam != null && row.startStationNam != "") {
                            return row.startStationNam;
                        } else {
                            return value;
                        }
                    },
                    sortable: true
                }, {
                    field: "collectionPort",
                    title: $.i18n.prop("集并港口"),
                    multiSort: true,
                    halign: "center",
                    editor: {
                        type: "combogrid",
                        options: HdUtils.code.getCPort({
                            parentId: "#selectCargoDatagrid",
                            isValid: false,
                            required: false
                        })
                    },
                    formatter: function(value, row, index) {
                        if (row.collectionPortNam != null && row.collectionPortNam != "") {
                            return row.collectionPortNam;
                        } else {
                            return value;
                        }
                    },
                    width: 120,
                    sortable: true
                }, {
                    field: "arrivalPort",
                    title: $.i18n.prop("到达港口"),
                    multiSort: true,
                    halign: "center",
                    editor: {
                        type: "combogrid",
                        options: HdUtils.code.getCPort({
                            parentId: "#selectCargoDatagrid",
                            isValid: false,
                            required: false
                        })
                    },
                    formatter: function(value, row, index) {
                        if (row.arrivalPortNam != null && row.arrivalPortNam != "") {
                            return row.arrivalPortNam;
                        } else {
                            return value;
                        }
                    },
                    width: 120,
                    sortable: true
                }, {
                    field: "consignee",
                    title: $.i18n.prop("收货人"),
                    multiSort: true,
                    width: 120,
                    formatter: function(value, row, index) {
                        if (row.consigneeNam != null && row.consigneeNam != "") {
                            return row.consigneeNam;
                        } else {
                            return value;
                        }
                    },
                    editor: {
                        type: "combogrid",
                        options: HdUtils.code.customerPay({
                            parentId: "#selectCargoDatagrid",
                            isValid: false,
                            fieldMapping: {
                                getOwner: 'custId'
                            },
                            required: false
                        })
                    },
                    halign: "center",
                    sortable: true
                }, {
                    field: "shipper",
                    title: $.i18n.prop("托运人"),
                    multiSort: true,
                    width: 120,
                    editor: {
                        type: "combogrid",
                        options: HdUtils.code.customerPay({
                            parentId: "#selectCargoDatagrid",
                            isValid: false,
                            fieldMapping: {
                                shipper: 'custId'
                            },
                            required: false
                        })
                    },
                    formatter: function(value, row, index) {
                        if (row.shipperNam != null && row.shipperNam != "") {
                            return row.shipperNam;
                        } else {
                            return value;
                        }
                    },
                    halign: "center",
                    sortable: true
                }, {
                    field: 'corpNam',
                    title: '<font color="red">' + $.i18n.prop("公司") + '</font>',
                    sortable: true,
                    halign: 'center',
                    width: 160
                }, {
                    field: 'deptNam',
                    title: '<font color="red">' + $.i18n.prop("部门") + '</font>',
                    sortable: true,
                    halign: 'center',
                    width: 90
                }, {
                    field: 'recNam',
                    title: '<font color="red">' + $.i18n.prop("创建人") + '</font>',
                    sortable: true,
                    halign: 'center',
                    width: 90
                }, {
                    field: 'recTim',
                    title: '<font color="red">' + $.i18n.prop("创建时间") + '</font>',
                    sortable: true,
                    halign: 'center',
                    formatter: $.hd.ezui.formatter.datetime,
                    width: 110
                }, {
                    field: 'updNam',
                    title: '<font color="red">' + $.i18n.prop("修改人") + '</font>',
                    sortable: true,
                    halign: 'center',
                    width: 90
                }, {
                    field: 'updTim',
                    title: '<font color="red">' + $.i18n.prop("修改时间") + '</font>',
                    sortable: true,
                    halign: 'center',
                    formatter: $.hd.ezui.formatter.datetime,
                    width: 110
                }]
            ]
        });
        $('#selectCargoDatagrid').datagrid('reloadFooter', [{
            cargoId: '本页小计(kg):',
            cargoWgt: 0
        }]);
        //设置弹窗确定时的回调
        HdUtils.dialog.setValue({
            saveHandler: function() {
                //获取datagrid中的数据
                var selectCargoRow = $("#selectCargoDatagrid").datagrid("getSelected");
                //将数据赋值到父表中
                if (selectCargoRow) {
                    var row = {};
                    row.contId = selectCargoRow.contId;
                    row.contCargoId = selectCargoRow.contCargoId;
                    row.setOwner = selectCargoRow.consignor;
                    row.statStation = selectCargoRow.startStation;
                    row.getOwner = selectCargoRow.consignee;
                    $("#ContBulkGrainDatagird").datagrid('hdAdd', row);
                }
                HdUtils.dialog.close();
            }
        });
    });
</script>